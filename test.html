<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORCHIDS Branch Search</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- MapTiler SDK -->
    <link href="https://cdn.maptiler.com/maptiler-sdk-js/v1.1.1/maptiler-sdk.css" rel="stylesheet" />
    <script src="https://cdn.maptiler.com/maptiler-sdk-js/v1.1.1/maptiler-sdk.umd.min.js"></script>
    <style>
        /* Use Inter as the default font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* A subtle background pattern for visual interest */
        body {
            background-color: #f8fafc; /* bg-slate-50 */
            background-image: radial-gradient(#dbeafe 1px, transparent 1px);
            background-size: 20px 20px;
        }
        /* Custom styles for animations */
        .result-card {
            animation: fadeIn 0.5s ease-in-out forwards;
            opacity: 0;
        }
        #map {
            height: 100%;
            min-height: 400px;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="text-gray-800 antialiased">

    <!-- App container with flex layout to push footer to the bottom -->
    <div class="flex flex-col min-h-screen">

        <!-- Header Section -->
        <header class="bg-white/80 backdrop-blur-lg border-b border-gray-200 sticky top-0 z-50">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <!-- Logo and Title -->
                    <div class="flex items-center space-x-3">
                        <svg class="h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0112 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 013 12c0-1.605.42-3.113 1.157-4.418" />
                        </svg>
                        <h1 class="text-xl font-bold text-gray-900">Orchids The International School</h1>
                    </div>
                    <!-- GitHub Link Button -->
                    <a href="https://github.com/rajputpritesh1" target="_blank" rel="noopener noreferrer" class="hidden sm:flex items-center space-x-2 text-sm font-semibold text-gray-600 hover:text-gray-900 transition-colors duration-200">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12c0 4.418 2.865 8.168 6.839 9.492.5.092.682-.217.682-.482 0-.237-.009-.868-.014-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.031-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.203 2.398.1 2.651.64.7 1.03 1.595 1.03 2.688 0 3.848-2.338 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.001 10.001 0 0022 12c0-5.523-4.477-10-10-10z" clip-rule="evenodd" />
                        </svg>
                        <span>Fork on Github</span>
                    </a>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-16 sm:py-24">
                
                <div class="text-center">
                    <!-- Hero Section -->
                    <h2 class="text-4xl sm:text-5xl lg:text-6xl font-extrabold text-gray-900 tracking-tight">
                        Find Your Nearest <span class="text-blue-600">Orchids The International School</span> Branch
                    </h2>
                    <p class="mt-4 max-w-2xl mx-auto text-lg text-gray-600">
                        Enter your location to find the nearest branch.
                    </p>

                    <!-- Search Box -->
                    <div class="mt-10 max-w-xl mx-auto">
                        <form id="search-form" class="relative group">
                            <svg class="absolute left-4 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                               <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" />
                            </svg>

                            <input 
                                type="search" 
                                name="search" 
                                id="search-input" 
                                placeholder="Enter your address, city, or area..."
                                class="w-full py-4 pl-12 pr-40 text-base md:text-lg bg-white border-2 border-gray-300 rounded-full shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all duration-300 ease-in-out"
                            >
                            <button type="submit" class="absolute right-2 top-1/2 -translate-y-1/2 bg-blue-600 text-white font-semibold px-4 md:px-6 py-2.5 rounded-full hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-300 ease-in-out transform group-hover:scale-105">
                                Search
                            </button>
                        </form>
                    </div>
                </div>
                
                <!-- Search Results Section -->
                <div id="results-container" class="mt-12 max-w-7xl mx-auto hidden">
                    <div class="lg:flex lg:space-x-8">
                        <!-- Map Container -->
                        <div class="lg:w-1/2">
                           <div id="map" class="w-full h-full rounded-lg shadow-md border border-gray-200"></div>
                        </div>
                        <!-- Results List -->
                        <div class="lg:w-1/2 mt-8 lg:mt-0">
                             <h3 id="results-title" class="text-2xl font-bold text-gray-800 text-left mb-6">Search Results</h3>
                            <div id="results-list" class="space-y-4 max-h-[600px] overflow-y-auto pr-2">
                                <!-- Dynamic search results will be inserted here -->
                            </div>
                            <p id="no-results" class="text-gray-600 text-lg mt-6 hidden">No branches found in this area.</p>
                             <p id="geocode-error" class="text-red-600 text-lg mt-6 hidden">Could not find this location. Please try again.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Branch Details Modal -->
        <div id="branch-details-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-800 bg-opacity-50 hidden">
            <div class="bg-white rounded-lg shadow-2xl p-6 w-11/12 md:w-1/2 relative">
                <button id="modal-close" class="absolute top-2 right-2 text-gray-600 hover:text-gray-800 text-2xl">&times;</button>
                <div id="modal-content" class="mt-6">
                    <!-- Branch details will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Footer Section -->
        <footer class="bg-white border-t border-gray-200">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 text-center text-sm text-gray-500">
                <p>&copy; 2025 K12 Techno Services Pvt Ltd. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <!-- Load external branch data -->
    <script src="branches.js"></script>
    <script>
        let map;
        let markers = [];
        let userLocationMarker;

        // branches are now loaded from branches.js

        function plotMarkers(branchList) {
            markers.forEach(marker => marker.remove());
            markers = [];
            branchList.forEach(branch => {
                if (branch.lat && branch.lon) {
                    const popup = new maptilersdk.Popup()
                        .setHTML(`<div class="p-1 font-sans"><strong>${branch.name}</strong><br>${branch.area}, ${branch.city}</div>`);
                    const marker = new maptilersdk.Marker()
                        .setLngLat([branch.lon, branch.lat])
                        .setPopup(popup)
                        .addTo(map);
                    markers.push(marker);
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // ===================================================================
            // =================== VERY IMPORTANT / ZAROORI ======================
            // ===================================================================
            // Replace 'YOUR_MAPTILER_API_KEY' with your actual MapTiler API key.
            maptilersdk.config.apiKey = 'mkRdO4MXKDiD31BFFZET';

            const defaultLocation = [77.5946, 12.9716]; // [lon, lat] for Bengaluru
            map = new maptilersdk.Map({
                container: 'map',
                style: maptilersdk.MapStyle.STREETS,
                center: defaultLocation,
                zoom: 9,
            });

            const searchForm = document.getElementById('search-form');
            const searchInput = document.getElementById('search-input');
            const resultsContainer = document.getElementById('results-container');
            const resultsList = document.getElementById('results-list');
            const resultsTitle = document.getElementById('results-title');
            const noResults = document.getElementById('no-results');
            const geocodeError = document.getElementById('geocode-error');

            searchForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const searchTerm = searchInput.value.trim();
                if (!searchTerm) return;

                resultsContainer.classList.add('hidden');
                geocodeError.classList.add('hidden');
                noResults.classList.add('hidden');

                try {
                    const geocodingResult = await maptilersdk.geocoding.forward(searchTerm, { limit: 1 });
                    console.log("Geocoding Result:", geocodingResult); // For debugging
                    if (geocodingResult.features.length) {
                        const location = geocodingResult.features[0].center; // [lon, lat]
                        const userLocation = { lat: location[1], lon: location[0] };

                        map.flyTo({ center: location, zoom: 10 });

                        if (userLocationMarker) {
                            userLocationMarker.remove();
                        }
                        userLocationMarker = new maptilersdk.Marker({ color: "#0000FF" })
                            .setLngLat(location)
                            .setPopup(new maptilersdk.Popup().setText('Your Location'))
                            .addTo(map);

                        const maxDistance = 15;
                        const nearbyBranches = branches.map(branch => {
                            if (!branch.lat || !branch.lon) return { ...branch, distance: Infinity };
                            const distance = getDistance(userLocation.lat, userLocation.lon, branch.lat, branch.lon);
                            return { ...branch, distance };
                        })
                        .filter(branch => branch.distance <= maxDistance)
                        .sort((a, b) => a.distance - b.distance);

                        console.log("Nearby branches found:", nearbyBranches); // For debugging

                        resultsTitle.textContent = `Branches within 15km of '${searchTerm}'`;
                        displayResults(nearbyBranches, true);
                    } else {
                        geocodeError.classList.remove('hidden');
                        resultsContainer.classList.add('hidden');
                    }
                } catch (error) {
                    console.error("Geocoding failed:", error);
                    geocodeError.classList.remove('hidden');
                    resultsContainer.classList.add('hidden');
                }
            });

            function getDistance(lat1, lon1, lat2, lon2) {
                const R = 6371; // Radius of the Earth in km
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            }

            function displayResults(results, showDistance = false) {
                resultsContainer.classList.remove('hidden');
                resultsList.innerHTML = '';
                
                if (results.length === 0) {
                    noResults.classList.remove('hidden');
                    resultsList.classList.add('hidden');
                } else {
                    resultsList.classList.remove('hidden');
                    noResults.classList.add('hidden');
                    results.forEach((branch, index) => {
                        const distanceInfo = showDistance && branch.distance !== Infinity ? `<p class="text-sm font-semibold text-blue-600 mt-2">Distance: ${branch.distance.toFixed(2)} km</p>` : '';
                        resultsList.innerHTML += `
                            <div class="result-card bg-white p-6 rounded-lg shadow-md border border-gray-200 text-left transition-transform transform hover:scale-105 duration-300">
                                <div class="flex items-start space-x-4">
                                    <div class="flex-shrink-0 mt-1">
                                        <svg class="h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                          <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 21h16.5M4.5 3h15M5.25 3v18m13.5-18v18M9 6.75h6.375a.75.75 0 01.75.75v10.5a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75V7.5a.75.75 0 01.75-.75z" />
                                        </svg>
                                    </div>
                                    <div class="flex-grow">
                                        <h4 class="text-xl font-semibold text-gray-800">${branch.name}</h4>
                                        <p class="text-gray-500 mt-1">${branch.area}, ${branch.city}</p>
                                        <p class="text-gray-600 mt-1">${branch.state} - ${branch.pincode}</p>
                                        ${distanceInfo}
                                        <button class="view-details-btn mt-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 focus:outline-none">View Details</button>
                                    </div>
                                </div>
                            </div>`;
                    });

                    // Attach event listeners for the view details buttons
                    document.querySelectorAll('.view-details-btn').forEach((btn, index) => {
                        btn.addEventListener('click', () => showBranchDetails(results[index]));
                    });
                }
                plotMarkers(results);
            }
        });

        function showBranchDetails(branch) {
            const modal = document.getElementById('branch-details-modal');
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `
                <h2 class="text-2xl font-bold mb-4">${branch.name}</h2>
                <p><strong>Board:</strong> ${branch.board || 'Not specified'}</p>
                <p><strong>Grades & Age Requirement:</strong> ${branch.grades || 'Not specified'}</p>
                <p><strong>Yearly Fee:</strong> ${branch.yearlyFee || 'Not specified'}</p>
                <p><strong>Facilities:</strong> ${branch.facilities || 'Not specified'}</p>
                <p><strong>Day Care:</strong> ${branch.daycare ? 'Yes' : 'No'}</p>
            `;
            modal.classList.remove('hidden');
        }

        // Close modal if close button is clicked (delegated)
        document.addEventListener('click', (e) => {
            if (e.target.id === 'modal-close') {
                document.getElementById('branch-details-modal').classList.add('hidden');
            }
        });
    </script>

</body>
</html>